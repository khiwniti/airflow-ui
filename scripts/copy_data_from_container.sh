#!/bin/bash
# Shell script to copy data from Airflow container to localhost
# This script copies all data files generated by DAGs to the local data_output directory

echo "ğŸ”„ Copying data from Airflow container to localhost..."

# Check if container is running
CONTAINER_NAME="synapes-analytics-airflow-scheduler-1"
CONTAINER_STATUS=$(docker ps --filter "name=$CONTAINER_NAME" --format "{{.Status}}")

if [ -z "$CONTAINER_STATUS" ]; then
    echo "âŒ Container $CONTAINER_NAME is not running!"
    echo "Please start the Airflow services first with: docker-compose up -d"
    exit 1
fi

echo "âœ… Container $CONTAINER_NAME is running"

# Create local data_output directory if it doesn't exist
if [ ! -d "data_output" ]; then
    mkdir -p data_output
    echo "ğŸ“ Created local data_output directory"
fi

# Copy data from container to localhost
echo "ğŸ“¥ Copying data files from container..."

if docker cp "${CONTAINER_NAME}:/opt/airflow/data_output/." "./data_output/"; then
    echo "âœ… Data files copied successfully!"
    
    # List the files that were copied
    if [ "$(ls -A data_output 2>/dev/null)" ]; then
        echo ""
        echo "ğŸ“Š Data files in localhost:"
        echo "=================================================="
        
        # List files with details
        ls -la data_output/ | grep -v "^total" | grep -v "^d" | while read -r line; do
            filename=$(echo "$line" | awk '{print $9}')
            size=$(echo "$line" | awk '{print $5}')
            date=$(echo "$line" | awk '{print $6, $7, $8}')
            if [ -n "$filename" ] && [ "$filename" != "." ] && [ "$filename" != ".." ]; then
                echo "ğŸ“„ $filename ($(echo "scale=2; $size/1024" | bc -l 2>/dev/null || echo "$size") KB) - $date"
            fi
        done
        
        echo "=================================================="
        
        # Count files
        file_count=$(find data_output -type f | wc -l)
        echo "ğŸ“ˆ Total files: $file_count"
        
        # Show summary by file type
        json_count=$(find data_output -name "*.json" -type f | wc -l)
        csv_count=$(find data_output -name "*.csv" -type f | wc -l)
        
        echo ""
        echo "ğŸ“‹ File Summary:"
        echo "   JSON files: $json_count"
        echo "   CSV files: $csv_count"
        
        # Show latest files
        echo ""
        echo "ğŸ•’ Latest 5 files:"
        find data_output -type f -printf '%T@ %p\n' | sort -nr | head -5 | while read -r timestamp filepath; do
            filename=$(basename "$filepath")
            echo "   â€¢ $filename"
        done
        
    else
        echo "â„¹ï¸ No data files found in container"
        echo "Run a DAG first to generate data files"
    fi
    
else
    echo "âŒ Failed to copy data files"
    exit 1
fi

echo ""
echo "ğŸ‰ Data copy completed successfully!"
echo "ğŸ’¾ Data files are now available in: $(pwd)/data_output"

# Optional: Show how to view the data
echo ""
echo "ğŸ’¡ Tips:"
echo "   â€¢ View JSON files: cat data_output/*.json | jq ."
echo "   â€¢ View CSV files: cat data_output/*.csv"
echo "   â€¢ Monitor new files: ls -lt data_output/"
